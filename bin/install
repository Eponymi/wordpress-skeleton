#!/usr/bin/env php
<?php

$root           = realpath(__DIR__ . '/../');
$interpreter    = sprintf('%s -d detect_unicode=Off', (PHP_OS == 'WINNT') ? 'php.exe' : 'php');
$commands       = array(
    sprintf('curl -s http://getcomposer.org/installer | %s -- %s', $interpreter, $root) => !file_exists($root.'/composer.phar'),
    sprintf('%s %s/composer.phar install --dev', $interpreter, $root)                   => true,
    'sudo gem install vagrant-hostmaster'                                               => !filter_var(`sudo gem list vagrant-hostmaster -i`, FILTER_VALIDATE_BOOLEAN),
    'sudo gem install capistrano'                                                       => !filter_var(`sudo gem list capistrano -i`, FILTER_VALIDATE_BOOLEAN),
    'sudo gem install capistrano-php'                                                   => !filter_var(`sudo gem list capistrano-php -i`, FILTER_VALIDATE_BOOLEAN),
    'sudo gem install capistrano-ext'                                                   => !filter_var(`sudo gem list capistrano-ext -i`, FILTER_VALIDATE_BOOLEAN),
    'sudo gem install railsless-deploy'                                                 => !filter_var(`sudo gem list railsless-deploy -i`, FILTER_VALIDATE_BOOLEAN),
);

chdir($root);

foreach ($commands as $command => $install) {
    if ($install) {
        passthru($command, $error);

        if ($error) {
            die(sprintf("Failed to install Composer [%s]\n", $error));
        }
    }
}
