require "capistrano/ext/multistage"
require "yaml"

set :stage_dir,         "deploy"
set :application,       "{{domain}}"
set :public_children,   []
set :shared_children,   %w(web/wp-content/uploads)

after "deploy:finalize_update", "wp:symlink"
after "deploy:update_code",     "wp:plugins:install"
after "deploy:update",          "wp:theme:activate"

after "deploy:setup" do
    dirs = [deploy_to, releases_path, shared_path]
    dirs += shared_children.map { |d| File.join(shared_path, d.split('/').last) }

    run "#{try_sudo} chown #{user} #{dirs.join(' ')}"
end

namespace :deploy do
    task :cold do
        after "deploy:finalize_update", "wp:db:create"
        after "deploy:finalize_update", "wp:install"

        setup
        update
        start
    end
end

pretty_errors

before "deploy:setup" do
    pretty_print "Setting up deployment structure"
end

after "deploy:setup" do
    puts_ok
end

before "deploy:update" do
    pretty_print "Starting \"#{stage}\" deployment"
    puts_ok
end

after "deploy:update" do
    pretty_print "Finishing \"#{stage}\" deployment"
    puts_ok
end
