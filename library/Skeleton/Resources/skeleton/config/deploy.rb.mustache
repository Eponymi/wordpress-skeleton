require "capistrano/ext/multistage"

set :stage_dir,         "deploy"

set :application,       "{{domain}}"
set :repository,        "{{repository}}"
set :scm,               :git

set :deploy_to,         "/var/www/#{application}"
set :deploy_via,        :remote_cache
set :group_writable,    true
set :use_sudo,          false

set :public_children,   []
set :shared_children,   %w(web/wp-content/uploads)

set :keep_releases,     5

default_run_options[:pty] = true

pretty_errors

before "deploy:setup" do
    pretty_print "Setting up deployment structure"
end

after "deploy:setup" do
    puts_ok
end

before "deploy:update" do
    pretty_print "Starting \"#{stage}\" deployment"
    puts_ok
end

after "deploy:update" do
    pretty_print "Finishing \"#{stage}\" deployment"
    puts_ok
end

after "deploy:finalize_update", "wp:symlink"
after "deploy:update_code",     "wp:plugins:install"
after "deploy:update",          "wp:theme:activate"

after "deploy:setup" do
    dirs = [deploy_to, releases_path, shared_path]
    dirs += shared_children.map { |d| File.join(shared_path, d.split('/').last) }

    run "#{try_sudo} chown #{user} #{dirs.join(' ')}"
end

namespace :deploy do
    task :cold do
        after "deploy:finalize_update", "wp:db:create"
        after "deploy:finalize_update", "wp:install"

        setup
        update
        start
    end
end
